# 3.2 Profile Setup — Feature Specification

## Overview

The Profile Setup flow is a 14-step, first-time-only sequence that collects personal information, preferences, and lifestyle details from authenticated users. It follows successful onboarding (see [3.1 Onboarding](./3.1-ONBOARDING.md)) and enables personalized mom-matching within the Raine app. Progress is persisted so users can resume if they exit mid-flow.

```
Login Success
     │
     ▼
┌─────────────────────────────────────────────────────┐
│              Profile Setup Flow (14 screens)          │
│         First-time only • Progress persisted         │
└─────────────────────────────────────────────────────┘
     │
     ├─► 1. Name (first + last initial)
     ├─► 2. Photo (upload)
     ├─► 3. Location (zip code)
     ├─► 4. City Feel (single select)
     ├─► 5. Children (dynamic form)
     ├─► 6. Before Motherhood (multi-select grid, max 3)
     ├─► 7. Perfect Weekend (multi-select grid, max 3)
     ├─► 8. Feel Like Yourself (single select)
     ├─► 9. Hard Truth (multi-select list)
     ├─► 10. Unexpected Joys (multi-select list)
     ├─► 11. Aesthetic (color grid, max 2)
     ├─► 12. Mom Friends (multi-select list)
     ├─► 13. What Brought You (single select)
     └─► 14. Generated Bio (review + confirm)
              │
              ▼
         Main App (Tabs)
```

---

## Status

**Implemented — 98%**

All 14 screens are implemented and functional. State management, navigation, geographic restriction, and bio generation (with dev fallback) are in place. Minor validation improvements (min resolution for photo, date validation for children, keyboard avoidance) are deferred to backlog.

---

## The 14 Steps

| Step | Screen Name | Route | Input Type | Validation Rules |
|------|-------------|-------|------------|------------------|
| 1 | Name | `/(profile-setup)/name` | First name (text), last initial (1 letter + auto ".") | First name: 1–50 chars, letters only. Last initial: exactly 1 letter. Both required. |
| 2 | Photo | `/(profile-setup)/photo` | Image upload (camera/gallery) | JPG, PNG, HEIC. Max 10MB. Min 300×300px (validation deferred). Required. |
| 3 | Location | `/(profile-setup)/location` | 5-digit zip code (individual boxes) | Valid US zip. Must resolve to approved Bay Area county. Out-of-area → waitlist flow. |
| 4 | City Feel | `/(profile-setup)/city-feel` | Single select (3 options) | Exactly 1 selection required. |
| 5 | Children | `/(profile-setup)/children` | Child count (1–4+), expecting toggle, per-child name + birth month/year | Birth date not in future; not >18 years ago. Due date must be in future if expecting. All fields complete. |
| 6 | Before Motherhood | `/(profile-setup)/before-motherhood` | Multi-select grid, max 3 | 1–3 selections required. |
| 7 | Perfect Weekend | `/(profile-setup)/perfect-weekend` | Multi-select grid, max 3 | 1–3 selections required. |
| 8 | Feel Like Yourself | `/(profile-setup)/feel-yourself` | Single select (4 options) | Exactly 1 selection required. |
| 9 | Hard Truth | `/(profile-setup)/hard-truth` | Multi-select list | At least 1 selection required. |
| 10 | Unexpected Joys | `/(profile-setup)/unexpected-joys` | Multi-select list | At least 1 selection required. |
| 11 | Aesthetic | `/(profile-setup)/aesthetic` | Color grid, max 2 | 1–2 selections required. |
| 12 | Mom Friends | `/(profile-setup)/mom-friends` | Multi-select list | At least 1 selection required. |
| 13 | What Brought You | `/(profile-setup)/what-brought-you` | Single select (4 options) | Exactly 1 selection required. |
| 14 | Generated Bio | `/(profile-setup)/bio` | AI-generated bio + approval | User must select "That's me!" to approve before completing. |

---

## Step-to-Route Mapping

Defined in `src/constants/profile-options.ts`:

| Step | Route |
|------|-------|
| 1 | `/(profile-setup)/name` |
| 2 | `/(profile-setup)/photo` |
| 3 | `/(profile-setup)/location` |
| 4 | `/(profile-setup)/city-feel` |
| 5 | `/(profile-setup)/children` |
| 6 | `/(profile-setup)/before-motherhood` |
| 7 | `/(profile-setup)/perfect-weekend` |
| 8 | `/(profile-setup)/feel-yourself` |
| 9 | `/(profile-setup)/hard-truth` |
| 10 | `/(profile-setup)/unexpected-joys` |
| 11 | `/(profile-setup)/aesthetic` |
| 12 | `/(profile-setup)/mom-friends` |
| 13 | `/(profile-setup)/what-brought-you` |
| 14 | `/(profile-setup)/bio` |

---

## Profile Data Schema

Source: `src/types/profile-setup.ts`

| Field | Type | Description |
|-------|------|-------------|
| `firstName` | `string` | First name (Screen 1) |
| `lastInitial` | `string` | Last name initial (Screen 1) |
| `photoURL` | `string` | Firebase Storage URL (Screen 2) |
| `zipCode` | `string` | 5-digit zip (Screen 3) |
| `city` | `string` | From zip lookup |
| `state` | `string` | From zip lookup |
| `county` | `string` | From zip-to-county mapping |
| `cityFeel` | `CityFeel \| null` | `rooted`, `finding_footing`, `local_but_missing` |
| `childCount` | `number` | 1, 2, 3, or 4+ |
| `isExpecting` | `boolean` | Whether user is expecting |
| `dueDate` | `DueDate \| null` | `{ month, year }` if expecting |
| `children` | `Child[]` | `{ name, birthMonth, birthYear }[]` |
| `beforeMotherhood` | `BeforeMotherhood[]` | Max 3 from 6 options |
| `perfectWeekend` | `PerfectWeekend[]` | Max 3 from 6 options |
| `feelYourself` | `FeelYourself \| null` | 1 of 4 options |
| `hardTruths` | `HardTruth[]` | 1+ of 6 options |
| `unexpectedJoys` | `UnexpectedJoy[]` | 1+ of 6 options |
| `aesthetic` | `Aesthetic[]` | Max 2 from 6 options |
| `momFriendStyle` | `MomFriendStyle[]` | 1+ of 6 options |
| `whatBroughtYou` | `WhatBroughtYou \| null` | 1 of 4 options |
| `generatedBio` | `string` | AI-generated bio text |
| `bioApproved` | `boolean` | User confirmed bio |
| `currentStep` | `number` | 1–14 |
| `completed` | `boolean` | Profile setup finished |

---

## State Management

**Zustand + MMKV persistence**

- Store: `src/store/profileSetupStore.ts`
- Storage key: `profile-setup`
- Persisted via `zustand/middleware/persist` with `mmkvStorage` from `src/store/persist.ts`

**Actions:**

- `setName`, `setPhoto`, `setLocation`, `setCityFeel`, `setChildren`
- `setBeforeMotherhood`, `setPerfectWeekend`, `setFeelYourself`
- `setHardTruths`, `setUnexpectedJoys`, `setAesthetic`, `setMomFriendStyle`, `setWhatBroughtYou`
- `setBio`, `setCurrentStep`, `decrementStep`, `completeSetup`, `reset`

---

## Navigation

- **Layout:** `src/app/(profile-setup)/_layout.tsx`
- **Progress dots:** Horizontal indicator at top; completed steps in orange, pending in slate.
- **Back button:** Visible when `currentStep > 1`; uses `decrementStep` and `router.replace(STEP_TO_ROUTE[previousStep])`.
- **Step tracking:** `setCurrentStep(n)` called on Continue; `currentStep` drives routing and dots.
- **Stack options:** `headerShown: false`, `gestureEnabled: false`, `animation: 'slide_from_right'`.

---

## Geographic Restriction

**Approved counties** (from `APPROVED_COUNTIES` in `src/constants/profile-options.ts`):

- San Francisco
- Marin
- Contra Costa
- Alameda
- San Mateo
- Santa Clara
- Sonoma
- Napa

**Logic:**

- Zip lookup via `services/location` (Zippopotam.us API + local `zipToCounty` mapping).
- If zip resolves to approved county → user continues to Screen 4.
- If out of area → navigate to `/(profile-setup)/out-of-area`; show modal: "Raine is currently only available in the San Francisco Bay Area".
- Waitlist: collect email, zip, city, state, county, timestamp; store in Firestore `waitlist` collection.

---

## Bio Generation

- **Primary:** Firebase Cloud Function `generateProfileBio` (OpenAI).
- **Fallback (dev/mock):** `buildFallbackBio` in `src/services/bio/index.ts` — uses name, location, child count, city feel to produce a template bio.
- **Regenerate:** `regenerateBio(profile, feedback?)` calls Cloud Function with `regenerate: true`; "Not quite" triggers feedback-based regeneration.
- **Loading:** Spinner during API calls; fallback on error.

---

## Components Used

| Component | Path | Purpose |
|-----------|------|---------|
| ProgressDots | `components/profile-setup/ProgressDots.tsx` | Horizontal step indicator (14 dots) |
| SetupHeader | `components/profile-setup/SetupHeader.tsx` | Headline + optional subheadline |
| ContinueButton | `components/profile-setup/ContinueButton.tsx` | Full-width bottom CTA |
| SelectionCard | `components/profile-setup/SelectionCard.tsx` | Single/multi-select list item |
| GridCard | `components/profile-setup/GridCard.tsx` | 2-column card with title + description |
| ColorGridCard | `components/profile-setup/ColorGridCard.tsx` | Color placeholder card (aesthetic) |
| ChildForm | `components/profile-setup/ChildForm.tsx` | Dynamic child entry (name, birth month/year) |
| MonthYearPicker | `components/profile-setup/MonthYearPicker.tsx` | Month/year dropdowns |
| PhotoUpload | `components/profile-setup/PhotoUpload.tsx` | Camera/gallery picker, resize, upload |
| OutOfAreaModal | `components/profile-setup/OutOfAreaModal.tsx` | Waitlist modal for out-of-area users |

Location screen uses `OtpInput` from `components/ui/OtpInput` for the 5-digit zip input.

---

## Cross-References

- **3.1 Onboarding:** Profile Setup is entered after successful authentication; users reach it only if they have completed referral + login.
- **User Flows (2-USER-FLOWS.md):** Profile Setup is the post-auth onboarding path before the main app.
- **Implementation plan:** `implementation-history/3-profile-setup-implementation-plan.md` (archived).
