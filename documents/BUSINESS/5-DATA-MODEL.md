# 5. Data Model

This document describes the complete data model for the Raine application, covering Firestore collections, TypeScript type definitions, local storage keys, Zustand store shapes, and entity relationships.

---

## Table of Contents

1. [Firestore Collections](#1-firestore-collections)
2. [TypeScript Type Definitions](#2-typescript-type-definitions)
3. [Local Storage (MMKV)](#3-local-storage-mmkv)
4. [Zustand Store Shapes](#4-zustand-store-shapes)
5. [Entity Relationships](#5-entity-relationships)
6. [Cross-References](#cross-references)

---

## 1. Firestore Collections

All Firestore access is routed through `src/services/firebase/firestore.ts`, which provides a lazy-loaded `getDb()` function with a mock mode for UI testing. Collection references are created via `getDb().collection(name)`.

### 1.1 `users`

Stores user profile data. Documents are keyed by Firebase Auth `uid`.

| Field                | Type                              | Required | Description                                      |
|----------------------|-----------------------------------|----------|--------------------------------------------------|
| `uid`                | `string`                          | Yes      | Firebase Auth user identifier (also the doc ID)  |
| `email`              | `string`                          | Yes      | User email address                               |
| `displayName`        | `string`                          | Yes      | User-facing display name                         |
| `photoURL`           | `string`                          | No       | URL to the user's profile photo                  |
| `subscriptionStatus` | `string`                          | Yes      | Current subscription tier or status              |
| `createdAt`          | `Firestore Timestamp`             | Yes      | Account creation timestamp                       |
| `lastSeen`           | `Firestore Timestamp`             | Yes      | Last time the user was active                    |
| `fcmToken`           | `string`                          | No       | Firebase Cloud Messaging token for push notifications |

**Service file:** `src/services/firebase/users.ts`
**Operations:** `getUserProfile`, `createUserProfile`, `updateUserProfile`, `updateUserFcmToken`, `listenToUserProfile`

---

### 1.2 `rooms`

Stores chat rooms. Each room contains an array of member UIDs. Documents are auto-generated by Firestore.

| Field                    | Type                              | Required | Description                                      |
|--------------------------|-----------------------------------|----------|--------------------------------------------------|
| `id`                     | `string`                          | Yes      | Auto-generated Firestore document ID             |
| `name`                   | `string`                          | Yes      | Display name for the room                        |
| `memberIds`              | `string[]`                        | Yes      | Array of user UIDs who are members               |
| `lastMessage`            | `object`                          | No       | Denormalized snapshot of the most recent message  |
| `lastMessage.text`       | `string`                          | --       | Text content of the last message                 |
| `lastMessage.senderId`   | `string`                          | --       | UID of the last message sender                   |
| `lastMessage.timestamp`  | `Firestore Timestamp`             | --       | Timestamp of the last message                    |
| `createdAt`              | `Firestore Timestamp`             | Yes      | Room creation timestamp                          |

**Service file:** `src/services/firebase/rooms.ts`
**Operations:** `listenToUserRooms`, `getRoom`, `createRoom`
**Query pattern:** Rooms for a user are queried with `where('memberIds', 'array-contains', uid)` and ordered by `lastMessage.timestamp` descending.

---

### 1.3 `rooms/{roomId}/messages` (subcollection)

Stores messages within a room as a subcollection. Documents are auto-generated by Firestore.

| Field        | Type                              | Required | Description                                      |
|--------------|-----------------------------------|----------|--------------------------------------------------|
| `id`         | `string`                          | Yes      | Auto-generated Firestore document ID             |
| `roomId`     | `string`                          | Yes      | Parent room identifier                           |
| `senderId`   | `string`                          | Yes      | UID of the message author                        |
| `text`       | `string`                          | Yes      | Message text content                             |
| `timestamp`  | `Firestore Timestamp`             | Yes      | When the message was sent                        |
| `reactions`  | `Record<string, string[]>`        | No       | Map of emoji keys to arrays of user UIDs who reacted |

**Service file:** `src/services/firebase/messages.ts`
**Operations:** `listenToMessages`, `fetchMoreMessages`, `sendMessage`, `updateReactions`
**Query pattern:** Messages are queried with `orderBy('timestamp', 'desc')` and support cursor-based pagination via `startAfter`.
**Side effect:** `sendMessage` also updates the parent room's `lastMessage` field for denormalization.

---

### 1.4 `communities` (inferred)

Community data is typed but service-layer access is not yet implemented in the codebase. The structure is defined by the `Community` interface.

| Field            | Type                   | Required | Description                                      |
|------------------|------------------------|----------|--------------------------------------------------|
| `id`             | `string`               | Yes      | Community identifier                             |
| `name`           | `string`               | Yes      | Community display name                           |
| `description`    | `string`               | Yes      | Community description text                       |
| `coverPhotoURL`  | `string`               | Yes      | URL to the community cover image                 |
| `category`       | `CommunityCategory`    | Yes      | One of: `location`, `child_age`, `experience`, `topic`, `stage` |
| `badge`          | `CommunityBadge`       | Yes      | One of: `LOCATION`, `AGE`, `EXPERIENCE`, `TOPIC`, `STAGE` |
| `memberCount`    | `number`               | Yes      | Current member count                             |
| `postCount`      | `number`               | Yes      | Total post count                                 |
| `lastActivityAt` | `Date`                 | Yes      | Timestamp of the most recent activity            |
| `tags`           | `string[]`             | Yes      | Searchable tags                                  |
| `isPublic`       | `boolean`              | Yes      | Whether the community is publicly visible        |
| `maxMembers`     | `number`               | No       | Optional member cap                              |

---

### 1.5 `drops` (inferred)

Curated product recommendation collections. Structure defined by the `Drop` interface.

| Field          | Type              | Required | Description                                      |
|----------------|-------------------|----------|--------------------------------------------------|
| `id`           | `string`          | Yes      | Drop identifier                                 |
| `title`        | `string`          | Yes      | Drop title                                      |
| `subtitle`     | `string`          | Yes      | Drop subtitle                                   |
| `category`     | `DropCategory`    | Yes      | One of: `NEWBORN`, `TODDLER`, `FEEDING`, `WELLNESS`, `LIFESTYLE`, `GEAR` |
| `coverColor`   | `string`          | Yes      | Hex color for the cover card                     |
| `sections`     | `DropSection[]`   | Yes      | Nested array of sections, each containing items  |
| `createdAt`    | `Date`            | Yes      | Creation timestamp                               |
| `publishedAt`  | `Date`            | Yes      | Publication timestamp                            |

**Nested: `DropSection`**

| Field    | Type           | Required | Description            |
|----------|----------------|----------|------------------------|
| `id`     | `string`       | Yes      | Section identifier     |
| `title`  | `string`       | Yes      | Section heading        |
| `items`  | `DropItem[]`   | Yes      | Products in this section |

**Nested: `DropItem`**

| Field          | Type      | Required | Description                 |
|----------------|-----------|----------|-----------------------------|
| `id`           | `string`  | Yes      | Item identifier             |
| `productName`  | `string`  | Yes      | Product display name        |
| `description`  | `string`  | Yes      | Product description         |
| `photoURL`     | `string`  | Yes      | Product image URL           |
| `shopURL`      | `string`  | Yes      | External purchase link      |
| `priceRange`   | `string`  | No       | Display price range         |
| `brand`        | `string`  | No       | Brand name                  |

---

### 1.6 `introductions` (inferred)

Manages user-to-user introduction requests. Structure defined by the `Introduction` interface.

| Field              | Type                   | Required | Description                                      |
|--------------------|------------------------|----------|--------------------------------------------------|
| `id`               | `string`               | Yes      | Introduction identifier                          |
| `fromUserId`       | `string`               | Yes      | UID of the user who initiated the introduction   |
| `toUserId`         | `string`               | Yes      | UID of the target user                           |
| `status`           | `IntroductionStatus`   | Yes      | One of: `pending`, `accepted`, `declined`, `expired` |
| `roomId`           | `string`               | No       | Room created if the introduction is accepted     |
| `mutualCommunities`| `number`               | Yes      | Count of shared communities                      |
| `matchDescription` | `string`               | Yes      | AI-generated description of why users match      |
| `createdAt`        | `Date`                 | Yes      | When the introduction was created                |
| `respondedAt`      | `Date`                 | No       | When the recipient responded                     |
| `expiresAt`        | `Date`                 | Yes      | Expiration deadline for the request              |

---

### 1.7 `waitlist` (inferred)

Referenced conceptually as part of the onboarding referral flow. The `ReferralCode` type suggests the existence of a waitlist or referral validation collection.

| Field           | Type      | Required | Description                        |
|-----------------|-----------|----------|------------------------------------|
| `code`          | `string`  | Yes      | The referral/invite code           |
| `validatedAt`   | `string`  | Yes      | ISO timestamp of when code was validated |

---

## 2. TypeScript Type Definitions

All types are located in `src/types/` and re-exported through `src/types/index.ts`.

### 2.1 `user.ts`

| Export        | Kind      | Description                                                  |
|---------------|-----------|--------------------------------------------------------------|
| `UserProfile` | Interface | Core user document shape stored in Firestore `users` collection. Fields: `uid`, `email`, `displayName`, `photoURL?`, `subscriptionStatus`, `createdAt`, `lastSeen`. |

### 2.2 `room.ts`

| Export  | Kind      | Description                                                         |
|---------|-----------|---------------------------------------------------------------------|
| `Room`  | Interface | Chat room document. Contains `id`, `name`, `memberIds`, optional `lastMessage` (denormalized), and `createdAt`. |

### 2.3 `message.ts`

| Export    | Kind      | Description                                                       |
|-----------|-----------|-------------------------------------------------------------------|
| `Message` | Interface | Individual chat message in a room subcollection. Fields: `id`, `roomId`, `senderId`, `text`, `timestamp`, optional `reactions` map. |

### 2.4 `community.ts`

| Export                 | Kind      | Description                                                       |
|------------------------|-----------|-------------------------------------------------------------------|
| `CommunityCategory`   | Type      | Union: `"location"`, `"child_age"`, `"experience"`, `"topic"`, `"stage"` |
| `CommunityBadge`      | Type      | Union: `"LOCATION"`, `"AGE"`, `"EXPERIENCE"`, `"TOPIC"`, `"STAGE"` |
| `Community`            | Interface | Full community entity with metadata, tags, and visibility settings |
| `CommunityPost`       | Interface | A post within a community, including author info, engagement counts, and pin/notable flags |
| `PostReply`            | Interface | A reply to a community post with author info and like count        |
| `CommunityMembership` | Interface | Represents a user's membership in a community, with notification preferences |
| `SavedPost`            | Interface | A bookmarked/saved post reference with denormalized metadata       |
| `UserQuestion`         | Interface | A question posted by the user in a community, with answer tracking  |

### 2.5 `drop.ts`

| Export         | Kind      | Description                                                       |
|----------------|-----------|-------------------------------------------------------------------|
| `DropCategory` | Type      | Union: `"NEWBORN"`, `"TODDLER"`, `"FEEDING"`, `"WELLNESS"`, `"LIFESTYLE"`, `"GEAR"` |
| `Drop`         | Interface | A curated product recommendation collection with nested sections   |
| `DropSection`  | Interface | A named section within a Drop containing an array of items         |
| `DropItem`     | Interface | An individual product recommendation with name, image, and shop link |
| `HeartedItem`  | Interface | A user-hearted product item with denormalized drop and section references |

### 2.6 `introduction.ts`

| Export               | Kind      | Description                                                       |
|----------------------|-----------|-------------------------------------------------------------------|
| `IntroductionStatus` | Type      | Union: `"pending"`, `"accepted"`, `"declined"`, `"expired"`       |
| `Introduction`       | Interface | A user-to-user introduction request with status, match info, and optional room link |
| `SavedConnection`    | Interface | A saved/bookmarked user profile from the introductions flow        |
| `MatchProfile`       | Interface | A recommended user profile with match score, bio, tags, and children info |

### 2.7 `profile-setup.ts`

| Export              | Kind      | Description                                                       |
|---------------------|-----------|-------------------------------------------------------------------|
| `Child`             | Interface | Child info: `name`, `birthMonth`, `birthYear`                     |
| `DueDate`           | Interface | Expected due date: `month`, `year`                                |
| `CityFeel`          | Type      | Union: `"rooted"`, `"finding_footing"`, `"local_but_missing"`     |
| `BeforeMotherhood`  | Type      | Union of 6 lifestyle interests before motherhood                  |
| `PerfectWeekend`    | Type      | Union of 6 ideal weekend activity types                           |
| `FeelYourself`      | Type      | Union of 4 self-care preferences                                  |
| `HardTruth`         | Type      | Union of 6 relatable motherhood challenges                        |
| `UnexpectedJoy`     | Type      | Union of 6 surprising positive experiences                        |
| `Aesthetic`          | Type      | Union of 6 style/aesthetic preferences                            |
| `MomFriendStyle`    | Type      | Union of 6 social connection styles                               |
| `WhatBroughtYou`    | Type      | Union of 4 motivation reasons for joining                         |
| `ProfileSetupData`  | Interface | Complete profile setup state: personal info, location, children, lifestyle preferences, generated bio, and step tracking |

### 2.8 `shared.ts`

| Export           | Kind      | Description                                                       |
|------------------|-----------|-------------------------------------------------------------------|
| `ActivityCounts` | Interface | Aggregate badge counts: `introRequests`, `unreadMessages`, `savedTips`, `questionResponses` |
| `TimelineItem`   | Interface | A unified timeline entry (intro, community post, or message) with preview and read state |

### 2.9 `auth.ts`

| Export           | Kind | Description                                                       |
|------------------|------|-------------------------------------------------------------------|
| `SocialProvider` | Type | Union: `"instagram"`, `"facebook"`, `"linkedin"` -- supported social auth providers |

### 2.10 `referral.ts`

| Export                   | Kind      | Description                                                       |
|--------------------------|-----------|-------------------------------------------------------------------|
| `ReferralCode`           | Interface | A validated referral code with `code` and `validatedAt` timestamp  |
| `ValidateReferralResult` | Interface | Result of a referral validation check: `valid` flag and optional `error` |

### 2.11 `index.ts` (barrel export)

Re-exports the following types for convenient imports:

- `UserProfile` from `./user`
- `Room` from `./room`
- `Message` from `./message`
- `SocialProvider` from `./auth`
- `ReferralCode`, `ValidateReferralResult` from `./referral`
- `ProfileSetupData`, `Child`, `DueDate`, `CityFeel`, `BeforeMotherhood`, `PerfectWeekend`, `FeelYourself`, `HardTruth`, `UnexpectedJoy`, `Aesthetic`, `MomFriendStyle`, `WhatBroughtYou` from `./profile-setup`

---

## 3. Local Storage (MMKV)

The application uses `react-native-mmkv` for fast, synchronous local storage. The MMKV instance is configured in `src/cache/mmkv.ts` with the storage ID `raine-storage`.

### 3.1 Explicit Storage Keys

Defined in the `storageKeys` constant:

| Key Constant             | Storage Key                         | Data Type     | Description                                         |
|--------------------------|-------------------------------------|---------------|-----------------------------------------------------|
| `authUser`               | `auth.user`                         | JSON (object) | Cached Firebase Auth user object for fast cold starts |
| `featureFlags`           | `feature.flags`                     | JSON (object) | Feature flag overrides for toggling app capabilities |
| `lastRoomId`             | `chat.lastRoomId`                   | `string`      | ID of the last opened chat room for quick resume     |
| `validatedReferralCode`  | `onboarding.referralCode`           | `string`      | The referral code entered during onboarding          |
| `referralValidatedAt`    | `onboarding.referralValidatedAt`    | `string`      | ISO timestamp of when the referral code was validated |

### 3.2 Zustand Persistence Keys

Zustand stores also write to MMKV via the `mmkvStorage` adapter defined in `src/store/persist.ts`. Each store writes a single JSON blob under its `name`:

| MMKV Key          | Store                     | Description                                   |
|-------------------|---------------------------|-----------------------------------------------|
| `app.store`       | `useAppStore`             | Active room, theme, notification preferences  |
| `profile-setup`   | `useProfileSetupStore`    | Full profile setup wizard state               |
| `communities`     | `useCommunitiesStore`     | Joined communities, saved posts, user questions |
| `drops`           | `useDropsStore`           | Hearted product items                         |
| `introductions`   | `useIntroductionsStore`   | Active conversations, saved connections, pending requests, recommended profiles |

### 3.3 Helper Utilities

| Function               | Signature                        | Description                                   |
|------------------------|----------------------------------|-----------------------------------------------|
| `setJson<T>`           | `(key: string, value: T) => void` | Serializes a value to JSON and stores it       |
| `getJson<T>`           | `(key: string) => T \| null`     | Retrieves and deserializes a JSON value, returns `null` on miss or parse failure |

---

## 4. Zustand Store Shapes

All Zustand stores use the `zustand/middleware` `persist` middleware (except `activityStore`) backed by MMKV. For detailed state management patterns, actions, and subscription logic, see [TECHNICAL/4-STATE-MANAGEMENT.md](../TECHNICAL/4-STATE-MANAGEMENT.md).

### 4.1 `useAppStore` (`app.store`)

Global application state.

| Field                   | Type                              | Persisted | Description                             |
|-------------------------|-----------------------------------|-----------|-----------------------------------------|
| `activeRoomId`          | `string \| null`                  | Yes       | Currently open chat room                |
| `isOnline`              | `boolean`                         | No        | Network connectivity status             |
| `theme`                 | `"light" \| "dark" \| "system"`   | Yes       | User theme preference                   |
| `notificationsEnabled`  | `boolean`                         | Yes       | Whether push notifications are enabled  |

### 4.2 `useProfileSetupStore` (`profile-setup`)

Holds the entire onboarding profile wizard state. Persisted shape mirrors the `ProfileSetupData` interface (see Section 2.7) including: `firstName`, `lastInitial`, `photoURL`, location fields, `children`, all lifestyle preference arrays, `generatedBio`, `bioApproved`, `currentStep`, and `completed`.

### 4.3 `useCommunitiesStore` (`communities`)

User-specific community engagement data.

| Field                | Type                      | Persisted | Description                              |
|----------------------|---------------------------|-----------|------------------------------------------|
| `joinedCommunities`  | `CommunityMembership[]`   | Yes       | Communities the user has joined          |
| `savedPosts`         | `SavedPost[]`             | Yes       | Bookmarked community posts               |
| `userQuestions`       | `UserQuestion[]`          | Yes       | Questions the user has posted            |

### 4.4 `useDropsStore` (`drops`)

User-hearted product items from Drops.

| Field          | Type              | Persisted | Description                        |
|----------------|-------------------|-----------|------------------------------------|
| `heartedItems` | `HeartedItem[]`   | Yes       | Products the user has favorited    |

### 4.5 `useIntroductionsStore` (`introductions`)

Introduction and matching state.

| Field                  | Type                  | Persisted | Description                                   |
|------------------------|-----------------------|-----------|-----------------------------------------------|
| `activeConversations`  | `Introduction[]`      | Yes       | Accepted introductions with active chat rooms  |
| `savedConnections`     | `SavedConnection[]`   | Yes       | Bookmarked user profiles                       |
| `pendingRequests`      | `Introduction[]`      | Yes       | Introduction requests awaiting response        |
| `recommendedProfiles`  | `MatchProfile[]`      | Yes       | AI-recommended user profiles for matching      |

### 4.6 `useActivityStore` (not persisted)

Transient activity badge counts.

| Field    | Type              | Persisted | Description                                     |
|----------|-------------------|-----------|-------------------------------------------------|
| `counts` | `ActivityCounts`  | No        | Badge counts: `introRequests`, `unreadMessages`, `savedTips`, `questionResponses` |

---

## 5. Entity Relationships

```
UserProfile (users)
 |
 |-- 1:N --> Room (rooms)              via Room.memberIds contains UserProfile.uid
 |            |
 |            |-- 1:N --> Message       via subcollection rooms/{id}/messages
 |                        (messages)    Message.senderId --> UserProfile.uid
 |
 |-- 1:N --> Introduction              fromUserId or toUserId --> UserProfile.uid
 |           (introductions)
 |            |
 |            |-- 0..1 --> Room         Introduction.roomId --> Room.id (created on accept)
 |
 |-- N:M --> Community                 via CommunityMembership (user joins many communities)
 |           (communities)
 |            |
 |            |-- 1:N --> CommunityPost
 |                        |
 |                        |-- 1:N --> PostReply
 |
 |-- 1:N --> SavedPost                 User bookmarks community posts
 |
 |-- 1:N --> UserQuestion              User posts questions in communities
 |
 |-- 1:N --> HeartedItem               User favorites items from Drops
 |            |
 |            |-- N:1 --> Drop          HeartedItem.dropId --> Drop.id
 |                        |
 |                        |-- 1:N --> DropSection
 |                                    |
 |                                    |-- 1:N --> DropItem
 |
 |-- 1:N --> SavedConnection           User saves profiles from introductions
 |
 |-- 0..1 --> ProfileSetupData         Onboarding wizard state (local only)
 |
 |-- 0..1 --> ReferralCode             Validated referral code (local only)
```

### Relationship Summary

| Relationship                        | Cardinality | Storage       | Description                                                |
|-------------------------------------|-------------|---------------|------------------------------------------------------------|
| User to Rooms                       | 1:N         | Firestore     | A user can be a member of many rooms via `memberIds`       |
| Room to Messages                    | 1:N         | Firestore     | Messages are a subcollection of the parent room            |
| User to Messages (as sender)        | 1:N         | Firestore     | A user can author many messages across rooms               |
| User to Introductions               | 1:N         | Firestore     | A user can send or receive many introductions              |
| Introduction to Room                | 0..1        | Firestore     | An accepted introduction may generate a chat room          |
| User to Communities                 | N:M         | Zustand/MMKV  | Users join many communities; tracked via `CommunityMembership` |
| Community to Posts                  | 1:N         | Firestore     | A community contains many posts                            |
| Post to Replies                     | 1:N         | Firestore     | A post can have many replies                               |
| User to Saved Posts                 | 1:N         | Zustand/MMKV  | Users bookmark posts for later reference                   |
| User to User Questions              | 1:N         | Zustand/MMKV  | Users post questions within communities                    |
| User to Hearted Items               | 1:N         | Zustand/MMKV  | Users favorite products from Drops                         |
| Drop to Sections to Items           | 1:N:N       | Firestore     | Drops contain sections, sections contain items             |
| User to Saved Connections           | 1:N         | Zustand/MMKV  | Users save interesting profiles from the introductions flow |
| User to Profile Setup               | 1:1         | Zustand/MMKV  | Onboarding wizard state persisted locally                  |

---

## Cross-References

| Document                                                       | Relevance                                            |
|----------------------------------------------------------------|------------------------------------------------------|
| [TECHNICAL/4-STATE-MANAGEMENT.md](../TECHNICAL/4-STATE-MANAGEMENT.md) | Detailed Zustand store patterns, actions, selectors, and persistence configuration |
| `src/types/`                                                   | Source of truth for all TypeScript interfaces and union types |
| `src/services/firebase/`                                       | Firestore CRUD operations, real-time listeners, and query patterns |
| `src/cache/mmkv.ts`                                            | MMKV storage instance configuration and helper utilities |
| `src/store/`                                                   | Zustand store definitions and persistence middleware setup |
